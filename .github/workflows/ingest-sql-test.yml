name: ECB SAFE — SQL Ingestion Test

# Manual-trigger only — this is a test workflow to validate the DuckDB CLI
# + SQL approach before it is promoted to a scheduled pipeline.
on:
  workflow_dispatch:

jobs:
  ingest-sql:
    name: DuckDB CLI ingestion
    runs-on: ubuntu-latest

    env:
      # Pin to the version used in the MotherDuck documentation.
      DUCKDB_VERSION: "1.4.2"

    steps:
      # ------------------------------------------------------------------ #
      # 1. Checkout                                                          #
      # ------------------------------------------------------------------ #
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------------ #
      # 2. DuckDB CLI                                                        #
      # ------------------------------------------------------------------ #
      - name: Download DuckDB CLI
        run: |
          curl -fsSL \
            "https://github.com/duckdb/duckdb/releases/download/v${DUCKDB_VERSION}/duckdb_cli-linux-amd64.zip" \
            -o duckdb_cli.zip
          unzip duckdb_cli.zip
          chmod +x duckdb
          ./duckdb --version

      # ------------------------------------------------------------------ #
      # 3. Pre-cache MotherDuck extension                                   #
      #                                                                      #
      # Same technique as the Python workflow: fetch via curl (HTTPS) and   #
      # drop into DuckDB's local extension cache so the CLI never attempts  #
      # its own http:// download.                                            #
      # ------------------------------------------------------------------ #
      - name: Pre-cache MotherDuck extension
        run: |
          EXT_DIR="$HOME/.duckdb/extensions/v${DUCKDB_VERSION}/linux_amd64"
          mkdir -p "$EXT_DIR"
          curl -fsSL \
            "https://extensions.duckdb.org/v${DUCKDB_VERSION}/linux_amd64/motherduck.duckdb_extension.gz" \
            | gunzip > "$EXT_DIR/motherduck.duckdb_extension"
          echo "MotherDuck extension cached at $EXT_DIR"

      # ------------------------------------------------------------------ #
      # 4. Download ECB SAFE microdata zip                                  #
      # ------------------------------------------------------------------ #
      - name: Download microdata zip
        run: |
          ZIP_URL=$(grep 'zip_url:' ingestion/config.yaml | awk '{print $2}' | tr -d '"')
          echo "Downloading: $ZIP_URL"
          curl -fsSL "$ZIP_URL" -o /tmp/safe_microdata.zip

      # ------------------------------------------------------------------ #
      # 5. Extract zip                                                       #
      # ------------------------------------------------------------------ #
      - name: Extract zip
        run: |
          mkdir -p /tmp/safe_extracted
          unzip /tmp/safe_microdata.zip -d /tmp/safe_extracted
          echo "Extracted CSV files:"
          find /tmp/safe_extracted -name "*.csv" | sort

      # ------------------------------------------------------------------ #
      # 6. Load into MotherDuck via SQL                                      #
      #                                                                      #
      # envsubst replaces ${CSV_DIR} in load.sql with the actual path,      #
      # then pipes the result straight into the DuckDB CLI — matching the   #
      # pattern from the MotherDuck documentation.                           #
      # ------------------------------------------------------------------ #
      - name: Load into MotherDuck via SQL
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
        run: |
          export CSV_DIR=$(find /tmp/safe_extracted -name "*.csv" \
            -exec dirname {} \; | sort -u | head -1)
          echo "CSV directory: $CSV_DIR"
          envsubst < ingestion/load.sql | ./duckdb
